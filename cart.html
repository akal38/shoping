<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ğŸ›’</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    h1 { color: #4CAF50; text-align: center; }
    .cart-items { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .cart-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; align-items: center; }
    .item-info { display: flex; align-items: center; gap: 10px; flex: 1; }
    .item-quantity { display: flex; align-items: center; gap: 5px; min-width: 120px; }
    .quantity-btn { width: 25px; height: 25px; border-radius: 50%; border: 1px solid #ddd; background: white; cursor: pointer; }
    .total { font-weight: bold; text-align: left; margin-top: 10px; font-size: 1.2em; }
    form { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    form input, form textarea { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
    button { background-color: #4CAF50; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; width: 100%; font-size: 16px; }
    button:hover { background-color: #388E3C; }
    .empty-cart { text-align: center; padding: 20px; color: #777; }
    .back-btn { background-color: #f44336; margin-bottom: 15px; }
    .back-btn:hover { background-color: #d32f2f; }
    .action-buttons { display: flex; gap: 5px; }
    .edit-btn { background-color: #2196F3; padding: 5px 10px; font-size: 14px; width: auto; }
    .edit-btn:hover { background-color: #0b7dda; }
    .remove-btn { background-color: #f44336; padding: 5px 10px; font-size: 14px; width: auto; }
    .remove-btn:hover { background-color: #d32f2f; }
    .quantity-controls { display: flex; align-items: center; gap: 5px; }
    .quantity-input { width: 40px; text-align: center; padding: 5px; }
    .item-image { width: 50px; height: 50px; object-fit: cover; border-radius: 5px; }
    .item-details { flex: 1; }
    .loading { text-align: center; padding: 20px; }
    .points-earned { color: #4CAF50; font-weight: bold; margin-top: 5px; }
  </style>
</head>
<body>
  <button class="back-btn" onclick="window.location.href='index.html'">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ØªØ¬Ø±</button>
  <h1>Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ğŸ›’</h1>
  
  <div class="cart-items" id="cartItems">
    <div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚...</div>
  </div>
  
  <form id="checkoutForm">
    <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
    <input type="text" id="name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
    <input type="tel" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" required>
    <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
    <textarea id="address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„" required></textarea>
    <div id="orderSummary" style="margin: 15px 0; padding: 10px; background: #f9f9f9; border-radius: 5px;"></div>
    <button type="submit" id="checkoutBtn">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</button>
  </form>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCHbyGbGx7P5mu6h0PecHGInvfX63Wvzqw",
      authDomain: "my-shop-96a73.firebaseapp.com",
      projectId: "my-shop-96a73",
      storageBucket: "my-shop-96a73.firebasestorage.app",
      messagingSenderId: "242872774955",
      appId: "1:242872774955:web:1b281b329bc189ea3e556e",
      measurementId: "G-NP5FHDTHEL"
    };

    // ØªÙ‡ÙŠØ¦Ø© Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const firestore = getFirestore(app);

    // Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ù„Ø©
    function loadCart() {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const cartItemsEl = document.getElementById('cartItems');
      
      if (cart.length === 0) {
        cartItemsEl.innerHTML = '<div class="empty-cart">Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ÙØ§Ø±ØºØ©</div>';
        document.getElementById('checkoutForm').style.display = 'none';
        return { items: [], total: 0, points: 0 };
      }

      // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ÙƒØ±Ø±Ø©
      const groupedItems = {};
      cart.forEach(item => {
        const key = item.id || `${item.name}_${item.price}`;
        if (!groupedItems[key]) {
          groupedItems[key] = { ...item, quantity: 1 };
        } else {
          groupedItems[key].quantity++;
        }
      });

      const groupedItemsArray = Object.values(groupedItems);
      let html = '', total = 0, points = 0;

      groupedItemsArray.forEach(item => {
        const itemTotal = item.price * item.quantity;
        total += itemTotal;
        points += Math.floor(itemTotal / 1000);
        
        html += `
          <div class="cart-item" data-id="${item.id}" data-name="${item.name}" data-price="${item.price}">
            <div class="item-info">
              <img src="${item.image || 'https://via.placeholder.com/50'}" class="item-image" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬">
              <div class="item-details">
                <div>${item.name}</div>
                <div class="points-earned">+${Math.floor(item.price / 1000)} Ù†Ù‚Ø·Ø© Ù„ÙƒÙ„ Ù‚Ø·Ø¹Ø©</div>
              </div>
            </div>
            <div class="item-quantity">
              <span class="quantity-display">${item.quantity} Ã— ${item.price} Ø¯Ø¬</span>
              <div class="quantity-controls" style="display:none;">
                <button class="quantity-btn minus-btn">-</button>
                <input type="number" class="quantity-input" value="${item.quantity}" min="1">
                <button class="quantity-btn plus-btn">+</button>
              </div>
            </div>
            <div class="item-total">${itemTotal} Ø¯Ø¬</div>
            <div class="action-buttons">
              <button class="edit-btn">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="remove-btn">Ø­Ø°Ù</button>
            </div>
          </div>
        `;
      });

      html += `
        <div class="total">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${total} Ø¯Ø¬</div>
        <div class="points-earned">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ÙƒØªØ³Ø¨Ø©: ${points} Ù†Ù‚Ø·Ø©</div>
      `;
      
      cartItemsEl.innerHTML = html;
      setupItemControls();
      
      // ØªØ­Ø¯ÙŠØ« Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨
      document.getElementById('orderSummary').innerHTML = `
        <strong>Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨:</strong>
        <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±: ${cart.length}</div>
        <div>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${total} Ø¯Ø¬</div>
        <div>Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ÙƒØªØ³Ø¨Ø©: ${points} Ù†Ù‚Ø·Ø©</div>
      `;
      
      return { items: groupedItemsArray, total, points };
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©
    function setupItemControls() {
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const itemElement = this.closest('.cart-item');
          const displayElement = itemElement.querySelector('.quantity-display');
          const controlsElement = itemElement.querySelector('.quantity-controls');
          
          if (controlsElement.style.display === 'none') {
            controlsElement.style.display = 'flex';
            displayElement.style.display = 'none';
            this.textContent = 'Ø­ÙØ¸';
          } else {
            const newQuantity = parseInt(itemElement.querySelector('.quantity-input').value);
            if (newQuantity > 0) {
              updateCartItem(
                itemElement.dataset.id, 
                itemElement.dataset.name, 
                parseFloat(itemElement.dataset.price), 
                newQuantity
              );
              controlsElement.style.display = 'none';
              displayElement.style.display = 'inline';
              displayElement.textContent = `${newQuantity} Ã— ${itemElement.dataset.price} Ø¯Ø¬`;
              this.textContent = 'ØªØ¹Ø¯ÙŠÙ„';
              itemElement.querySelector('.item-total').textContent = `${newQuantity * parseFloat(itemElement.dataset.price)} Ø¯Ø¬`;
              updateOrderSummary();
            } else {
              alert('Ø§Ù„ÙƒÙ…ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ 1');
            }
          }
        });
      });

      document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const itemElement = this.closest('.cart-item');
          if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ø³Ù„Ø©ØŸ')) {
            removeCartItem(
              itemElement.dataset.id, 
              itemElement.dataset.name, 
              parseFloat(itemElement.dataset.price)
            );
            itemElement.remove();
            updateOrderSummary();
          }
        });
      });

      document.querySelectorAll('.plus-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const input = this.parentElement.querySelector('.quantity-input');
          input.value = parseInt(input.value) + 1;
        });
      });

      document.querySelectorAll('.minus-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const input = this.parentElement.querySelector('.quantity-input');
          if (parseInt(input.value) > 1) {
            input.value = parseInt(input.value) - 1;
          }
        });
      });
    }

    // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ØµØ± ÙÙŠ Ø§Ù„Ø³Ù„Ø©
    function updateCartItem(id, name, price, newQuantity) {
      let cart = JSON.parse(localStorage.getItem('cart')) || [];
      // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
      cart = cart.filter(item => !(
        (item.id === id || (!item.id && item.name === name)) && 
        item.price === price
      ));
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      for (let i = 0; i < newQuantity; i++) {
        cart.push({ id, name, price });
      }
      localStorage.setItem('cart', JSON.stringify(cart));
    }

    // Ø­Ø°Ù Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ø³Ù„Ø©
    function removeCartItem(id, name, price) {
      let cart = JSON.parse(localStorage.getItem('cart')) || [];
      cart = cart.filter(item => !(
        (item.id === id || (!item.id && item.name === name)) && 
        item.price === price
      ));
      localStorage.setItem('cart', JSON.stringify(cart));
      
      if (cart.length === 0) {
        document.getElementById('cartItems').innerHTML = '<div class="empty-cart">Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ÙØ§Ø±ØºØ©</div>';
        document.getElementById('checkoutForm').style.display = 'none';
      }
    }

    // ØªØ­Ø¯ÙŠØ« Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨
    function updateOrderSummary() {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      if (cart.length === 0) {
        document.getElementById('cartItems').innerHTML = '<div class="empty-cart">Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ÙØ§Ø±ØºØ©</div>';
        document.getElementById('checkoutForm').style.display = 'none';
        return;
      }

      const cartData = loadCart();
      document.getElementById('orderSummary').innerHTML = `
        <strong>Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨:</strong>
        <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±: ${cart.length}</div>
        <div>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${cartData.total} Ø¯Ø¬</div>
        <div>Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ÙƒØªØ³Ø¨Ø©: ${cartData.points} Ù†Ù‚Ø·Ø©</div>
      `;
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
    document.getElementById('checkoutForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const cartData = loadCart();
      if (cartData.items.length === 0) {
        alert('Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ÙØ§Ø±ØºØ©!');
        return;
      }

      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim();
      const address = document.getElementById('address').value.trim();

      if (!name || !phone || !address) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
        return;
      }

      const order = {
        id: Date.now().toString(),
        customer: { name, phone, email: email || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯', address },
        items: cartData.items,
        total: cartData.total,
        points: cartData.points,
        date: new Date().toISOString(),
        status: 'Ø¬Ø¯ÙŠØ¯'
      };

      // Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ localStorage
      const orders = JSON.parse(localStorage.getItem('orders')) || [];
      orders.push(order);
      localStorage.setItem('orders', JSON.stringify(orders));

      // Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Firestore
      try {
        await addDoc(collection(firestore, "orders"), order);
        console.log("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Firestore");
      } catch (err) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨:", err);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
        return;
      }

      // ØªØ­Ø¯ÙŠØ« Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      updateUserPoints(name, phone, email, address, cartData.points);

      // Ø¥ÙØ±Ø§Øº Ø§Ù„Ø³Ù„Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
      localStorage.removeItem('cart');
      alert('ØªÙ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ø´ÙƒØ±Ø§Ù‹ Ù„Ø´Ø±Ø§Ø¦Ùƒ Ù…Ø¹Ù†Ø§.');
      window.location.href = 'index.html';
    });

    // ØªØ­Ø¯ÙŠØ« Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    function updateUserPoints(name, phone, email, address, pointsToAdd) {
      // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      const userData = JSON.parse(localStorage.getItem('user_data')) || {};
      userData[name] = { name, phone, email, address };
      localStorage.setItem('user_data', JSON.stringify(userData));

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
      const now = new Date();
      const pointsKey = `user_points_${now.getFullYear()}_${String(now.getMonth() + 1).padStart(2, '0')}`;
      const monthlyPoints = JSON.parse(localStorage.getItem(pointsKey)) || {};
      monthlyPoints[name] = (monthlyPoints[name] || 0) + pointsToAdd;
      localStorage.setItem(pointsKey, JSON.stringify(monthlyPoints));

      // ÙŠÙ…ÙƒÙ†Ùƒ Ù‡Ù†Ø§ Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ù„Ø­ÙØ¸ Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙŠ Firebase Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ù„Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    window.addEventListener('DOMContentLoaded', () => {
      loadCart();
    });
  </script>
</body>
</html>