<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>سلة التسوق 🛒</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    h1 { color: #4CAF50; text-align: center; }
    .cart-items { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .cart-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; align-items: center; }
    .item-info { display: flex; align-items: center; gap: 10px; flex: 1; }
    .item-quantity { display: flex; align-items: center; gap: 5px; min-width: 120px; }
    .quantity-btn { width: 25px; height: 25px; border-radius: 50%; border: 1px solid #ddd; background: white; cursor: pointer; }
    .total { font-weight: bold; text-align: left; margin-top: 10px; font-size: 1.2em; }
    form { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    form input, form textarea { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
    button { background-color: #4CAF50; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; width: 100%; font-size: 16px; }
    button:hover { background-color: #388E3C; }
    .empty-cart { text-align: center; padding: 20px; color: #777; }
    .back-btn { background-color: #f44336; margin-bottom: 15px; }
    .back-btn:hover { background-color: #d32f2f; }
    .action-buttons { display: flex; gap: 5px; }
    .edit-btn { background-color: #2196F3; padding: 5px 10px; font-size: 14px; width: auto; }
    .edit-btn:hover { background-color: #0b7dda; }
    .remove-btn { background-color: #f44336; padding: 5px 10px; font-size: 14px; width: auto; }
    .remove-btn:hover { background-color: #d32f2f; }
    .quantity-controls { display: flex; align-items: center; gap: 5px; }
    .quantity-input { width: 40px; text-align: center; padding: 5px; }
    .item-image { width: 50px; height: 50px; object-fit: cover; border-radius: 5px; }
    .item-details { flex: 1; }
    .loading { text-align: center; padding: 20px; }
    .points-earned { color: #4CAF50; font-weight: bold; margin-top: 5px; }
  </style>
</head>
<body>
  <button class="back-btn" onclick="window.location.href='index.html'">← العودة إلى المتجر</button>
  <h1>سلة التسوق 🛒</h1>
  
  <div class="cart-items" id="cartItems">
    <div class="loading">جاري تحميل سلة التسوق...</div>
  </div>
  
  <form id="checkoutForm">
    <h3>معلومات العميل</h3>
    <input type="text" id="name" placeholder="الاسم الكامل" required>
    <input type="tel" id="phone" placeholder="رقم الهاتف" required>
    <input type="email" id="email" placeholder="البريد الإلكتروني (اختياري)">
    <textarea id="address" placeholder="العنوان بالتفصيل" required></textarea>
    <div id="orderSummary" style="margin: 15px 0; padding: 10px; background: #f9f9f9; border-radius: 5px;"></div>
    <button type="submit" id="checkoutBtn">إتمام الطلب</button>
  </form>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // إعدادات Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCHbyGbGx7P5mu6h0PecHGInvfX63Wvzqw",
      authDomain: "my-shop-96a73.firebaseapp.com",
      projectId: "my-shop-96a73",
      storageBucket: "my-shop-96a73.firebasestorage.app",
      messagingSenderId: "242872774955",
      appId: "1:242872774955:web:1b281b329bc189ea3e556e",
      measurementId: "G-NP5FHDTHEL"
    };

    // تهيئة Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const firestore = getFirestore(app);

    // دالة تحميل السلة
    function loadCart() {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const cartItemsEl = document.getElementById('cartItems');
      
      if (cart.length === 0) {
        cartItemsEl.innerHTML = '<div class="empty-cart">سلة التسوق فارغة</div>';
        document.getElementById('checkoutForm').style.display = 'none';
        return { items: [], total: 0, points: 0 };
      }

      // تجميع العناصر المكررة
      const groupedItems = {};
      cart.forEach(item => {
        const key = item.id || `${item.name}_${item.price}`;
        if (!groupedItems[key]) {
          groupedItems[key] = { ...item, quantity: 1 };
        } else {
          groupedItems[key].quantity++;
        }
      });

      const groupedItemsArray = Object.values(groupedItems);
      let html = '', total = 0, points = 0;

      groupedItemsArray.forEach(item => {
        const itemTotal = item.price * item.quantity;
        total += itemTotal;
        points += Math.floor(itemTotal / 1000);
        
        html += `
          <div class="cart-item" data-id="${item.id}" data-name="${item.name}" data-price="${item.price}">
            <div class="item-info">
              <img src="${item.image || 'https://via.placeholder.com/50'}" class="item-image" alt="صورة المنتج">
              <div class="item-details">
                <div>${item.name}</div>
                <div class="points-earned">+${Math.floor(item.price / 1000)} نقطة لكل قطعة</div>
              </div>
            </div>
            <div class="item-quantity">
              <span class="quantity-display">${item.quantity} × ${item.price} دج</span>
              <div class="quantity-controls" style="display:none;">
                <button class="quantity-btn minus-btn">-</button>
                <input type="number" class="quantity-input" value="${item.quantity}" min="1">
                <button class="quantity-btn plus-btn">+</button>
              </div>
            </div>
            <div class="item-total">${itemTotal} دج</div>
            <div class="action-buttons">
              <button class="edit-btn">تعديل</button>
              <button class="remove-btn">حذف</button>
            </div>
          </div>
        `;
      });

      html += `
        <div class="total">المجموع: ${total} دج</div>
        <div class="points-earned">إجمالي النقاط المكتسبة: ${points} نقطة</div>
      `;
      
      cartItemsEl.innerHTML = html;
      setupItemControls();
      
      // تحديث ملخص الطلب
      document.getElementById('orderSummary').innerHTML = `
        <strong>ملخص الطلب:</strong>
        <div>عدد العناصر: ${cart.length}</div>
        <div>المجموع: ${total} دج</div>
        <div>النقاط المكتسبة: ${points} نقطة</div>
      `;
      
      return { items: groupedItemsArray, total, points };
    }

    // إعداد عناصر التحكم في الكمية
    function setupItemControls() {
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const itemElement = this.closest('.cart-item');
          const displayElement = itemElement.querySelector('.quantity-display');
          const controlsElement = itemElement.querySelector('.quantity-controls');
          
          if (controlsElement.style.display === 'none') {
            controlsElement.style.display = 'flex';
            displayElement.style.display = 'none';
            this.textContent = 'حفظ';
          } else {
            const newQuantity = parseInt(itemElement.querySelector('.quantity-input').value);
            if (newQuantity > 0) {
              updateCartItem(
                itemElement.dataset.id, 
                itemElement.dataset.name, 
                parseFloat(itemElement.dataset.price), 
                newQuantity
              );
              controlsElement.style.display = 'none';
              displayElement.style.display = 'inline';
              displayElement.textContent = `${newQuantity} × ${itemElement.dataset.price} دج`;
              this.textContent = 'تعديل';
              itemElement.querySelector('.item-total').textContent = `${newQuantity * parseFloat(itemElement.dataset.price)} دج`;
              updateOrderSummary();
            } else {
              alert('الكمية يجب أن تكون على الأقل 1');
            }
          }
        });
      });

      document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const itemElement = this.closest('.cart-item');
          if (confirm('هل أنت متأكد من حذف هذا العنصر من السلة؟')) {
            removeCartItem(
              itemElement.dataset.id, 
              itemElement.dataset.name, 
              parseFloat(itemElement.dataset.price)
            );
            itemElement.remove();
            updateOrderSummary();
          }
        });
      });

      document.querySelectorAll('.plus-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const input = this.parentElement.querySelector('.quantity-input');
          input.value = parseInt(input.value) + 1;
        });
      });

      document.querySelectorAll('.minus-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const input = this.parentElement.querySelector('.quantity-input');
          if (parseInt(input.value) > 1) {
            input.value = parseInt(input.value) - 1;
          }
        });
      });
    }

    // تحديث عنصر في السلة
    function updateCartItem(id, name, price, newQuantity) {
      let cart = JSON.parse(localStorage.getItem('cart')) || [];
      // إزالة جميع العناصر المطابقة
      cart = cart.filter(item => !(
        (item.id === id || (!item.id && item.name === name)) && 
        item.price === price
      ));
      // إضافة الكمية الجديدة
      for (let i = 0; i < newQuantity; i++) {
        cart.push({ id, name, price });
      }
      localStorage.setItem('cart', JSON.stringify(cart));
    }

    // حذف عنصر من السلة
    function removeCartItem(id, name, price) {
      let cart = JSON.parse(localStorage.getItem('cart')) || [];
      cart = cart.filter(item => !(
        (item.id === id || (!item.id && item.name === name)) && 
        item.price === price
      ));
      localStorage.setItem('cart', JSON.stringify(cart));
      
      if (cart.length === 0) {
        document.getElementById('cartItems').innerHTML = '<div class="empty-cart">سلة التسوق فارغة</div>';
        document.getElementById('checkoutForm').style.display = 'none';
      }
    }

    // تحديث ملخص الطلب
    function updateOrderSummary() {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      if (cart.length === 0) {
        document.getElementById('cartItems').innerHTML = '<div class="empty-cart">سلة التسوق فارغة</div>';
        document.getElementById('checkoutForm').style.display = 'none';
        return;
      }

      const cartData = loadCart();
      document.getElementById('orderSummary').innerHTML = `
        <strong>ملخص الطلب:</strong>
        <div>عدد العناصر: ${cart.length}</div>
        <div>المجموع: ${cartData.total} دج</div>
        <div>النقاط المكتسبة: ${cartData.points} نقطة</div>
      `;
    }

    // إرسال الطلب
    document.getElementById('checkoutForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const cartData = loadCart();
      if (cartData.items.length === 0) {
        alert('سلة التسوق فارغة!');
        return;
      }

      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim();
      const address = document.getElementById('address').value.trim();

      if (!name || !phone || !address) {
        alert('الرجاء ملء جميع الحقول المطلوبة');
        return;
      }

      const order = {
        id: Date.now().toString(),
        customer: { name, phone, email: email || 'غير محدد', address },
        items: cartData.items,
        total: cartData.total,
        points: cartData.points,
        date: new Date().toISOString(),
        status: 'جديد'
      };

      // حفظ الطلب في localStorage
      const orders = JSON.parse(localStorage.getItem('orders')) || [];
      orders.push(order);
      localStorage.setItem('orders', JSON.stringify(orders));

      // حفظ الطلب في Firestore
      try {
        await addDoc(collection(firestore, "orders"), order);
        console.log("✅ تم حفظ الطلب في Firestore");
      } catch (err) {
        console.error("❌ خطأ في حفظ الطلب:", err);
        alert("حدث خطأ أثناء حفظ الطلب، الرجاء المحاولة مرة أخرى");
        return;
      }

      // تحديث نقاط المستخدم
      updateUserPoints(name, phone, email, address, cartData.points);

      // إفراغ السلة وإعادة التوجيه
      localStorage.removeItem('cart');
      alert('تم إتمام الطلب بنجاح! شكراً لشرائك معنا.');
      window.location.href = 'index.html';
    });

    // تحديث نقاط المستخدم
    function updateUserPoints(name, phone, email, address, pointsToAdd) {
      // حفظ بيانات المستخدم
      const userData = JSON.parse(localStorage.getItem('user_data')) || {};
      userData[name] = { name, phone, email, address };
      localStorage.setItem('user_data', JSON.stringify(userData));

      // حساب النقاط الشهرية
      const now = new Date();
      const pointsKey = `user_points_${now.getFullYear()}_${String(now.getMonth() + 1).padStart(2, '0')}`;
      const monthlyPoints = JSON.parse(localStorage.getItem(pointsKey)) || {};
      monthlyPoints[name] = (monthlyPoints[name] || 0) + pointsToAdd;
      localStorage.setItem(pointsKey, JSON.stringify(monthlyPoints));

      // يمكنك هنا إضافة كود لحفظ النقاط في Firebase إذا أردت
    }

    // تحميل السلة عند بدء التشغيل
    window.addEventListener('DOMContentLoaded', () => {
      loadCart();
    });
  </script>
</body>
</html>