<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† ğŸ†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {font-family: 'Cairo', sans-serif; background: linear-gradient(to bottom, #fdfcfb, #e2d1c3); padding: 20px; text-align: center;}
    h1 {color: #6a1b9a;}
    #monthButtons {margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 5px;}
    .month-btn {margin: 2px; padding: 6px 12px; background-color: #6a1b9a; color: white; border: none; border-radius: 5px; cursor: pointer;}
    .month-btn.active {background-color: #4a148c; font-weight: bold; box-shadow: 0 0 5px rgba(0,0,0,0.3);}
    .month-btn:hover {background-color: #4a148c;}
    table {width: 100%; max-width: 600px; margin: 20px auto; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);}
    th, td {padding: 15px; border-bottom: 1px solid #eee;}
    th {background-color: #6a1b9a; color: white;}
    tr:nth-child(even) {background-color: #f9f9f9;}
    .winner {background-color: #ffeb3b; font-weight: bold;}
    .back-btn {margin-top: 30px; background-color: #6a1b9a; color: white; border: none; padding: 10px 20px; font-size: 16px; border-radius: 6px; cursor: pointer; transition: 0.3s;}
    .back-btn:hover {background-color: #4a148c;}
    .username {color: #1a73e8; cursor: pointer; text-decoration: underline;}
    .modal {display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;}
    .modal-content {background: white; padding: 20px; border-radius: 10px; max-width: 420px; width: 100%; text-align: right; box-shadow: 0 4px 20px rgba(0,0,0,0.2);}
    .modal-content h3 {margin-top: 0; color: #6a1b9a;}
    .modal-close {margin-top: 15px; display: inline-block; background-color: #6a1b9a; color: #fff; padding: 8px 14px; border-radius: 6px; border: none; cursor: pointer;}
    .no-data {padding: 20px; color: #777;}
  </style>
</head>
<body>
  <h1>ğŸ† Ø§Ù„Ù…ØªØµØ¯Ø±ÙˆÙ† Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</h1>
  <div id="monthButtons"></div>

  <table>
    <thead>
      <tr>
        <th>Ø§Ù„ØªØ±ØªÙŠØ¨</th>
        <th>Ø§Ù„Ø§Ø³Ù…
          <button onclick="sortByName()" style="font-size: 12px; margin-right: 6px; padding: 3px 6px; background-color: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ”¤</button>
        </th>
        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·</th>
        <th>Ø­Ø°Ù</th>
      </tr>
    </thead>
    <tbody id="leaderboard"></tbody>
  </table>

  <button class="back-btn" onclick="window.location.href='admin.html'">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© âš™ï¸</button>

  <div id="userModal" class="modal" onclick="closeModal(event)">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
      <div id="modalBody"></div>
      <button class="modal-close" onclick="hideModal()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>

  <script>
    // ğŸ”¹ ØªÙ‡ÙŠØ¦Ø© Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCHbyGbGx7P5mu6h0PecHGInvfX63Wvzqw",
      authDomain: "my-shop-96a73.firebaseapp.com",
      projectId: "my-shop-96a73",
      storageBucket: "my-shop-96a73.appspot.com",
      messagingSenderId: "242872774955",
      appId: "1:242872774955:web:1b281b329bc189ea3e556e",
      measurementId: "G-NP5FHDTHEL"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const monthButtonsDiv = document.getElementById('monthButtons');
    const leaderboard = document.getElementById('leaderboard');
    const allUsersData = JSON.parse(localStorage.getItem('user_data')) || {};
    const monthNames = ['Ø¬Ø§Ù†ÙÙŠ', 'ÙÙŠÙØ±ÙŠ', 'Ù…Ø§Ø±Ø³', 'Ø£ÙØ±ÙŠÙ„', 'Ù…Ø§ÙŠ', 'Ø¬ÙˆØ§Ù†', 'Ø¬ÙˆÙŠÙ„ÙŠØ©', 'Ø£ÙˆØª', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];

    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const currentKey = `user_points_${year}_${month}`;

    // ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    initLeaderboard();

    async function initLeaderboard() {
      await checkAndCreateNewMonth();
      createMonthButtons();
      loadLeaderboard(currentKey);
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯ ÙˆØ¥Ù†Ø´Ø§Ø¦Ù‡ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
    async function checkAndCreateNewMonth() {
      const lastAccessed = localStorage.getItem('last_accessed_month');
      if (lastAccessed !== currentKey) {
        localStorage.setItem('last_accessed_month', currentKey);
        // ÙŠÙ…ÙƒÙ†Ùƒ Ù‡Ù†Ø§ Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù†Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯
        console.log(`Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯: ${currentKey}`);
      }
    }

    async function loadLeaderboard(pointsKey) {
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± Ø§Ù„Ù†Ø´Ø·
      document.querySelectorAll('.month-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.key === pointsKey) btn.classList.add('active');
      });

      let allPoints = {};
      try {
        const snapshot = await db.collection(pointsKey).get();
        snapshot.forEach(doc => {
          allPoints[doc.id] = doc.data().points;
        });
      } catch (e) {
        console.warn("âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firestore:", e);
      }

      if (Object.keys(allPoints).length === 0) {
        allPoints = JSON.parse(localStorage.getItem(pointsKey)) || {};
      } else {
        localStorage.setItem(pointsKey, JSON.stringify(allPoints));
      }

      const users = Object.keys(allPoints).map(name => ({ name, points: allPoints[name] }));
      users.sort((a, b) => b.points - a.points);

      leaderboard.innerHTML = '';
      if (users.length === 0) {
        leaderboard.innerHTML = `<tr><td colspan="4">ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</td></tr>`;
        return;
      }

      users.forEach((user, index) => {
        const safeName = escapeHtml(user.name);
        const row = document.createElement('tr');
        if (index === 0) row.classList.add('winner');
        row.innerHTML = `
          <td>${index + 1}</td>
          <td><span class="username" data-name="${safeName}">${safeName}</span></td>
          <td>${user.points}</td>
          <td><button onclick="deleteUser('${safeName}', '${pointsKey}')" style="background:red; color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer;">ğŸ—‘ï¸</button></td>
        `;
        leaderboard.appendChild(row);
      });

      document.querySelectorAll('.username').forEach(el => {
        el.addEventListener('click', e => {
          const name = e.currentTarget.getAttribute('data-name');
          showUserData(name, pointsKey);
        });
      });
    }

    function createMonthButtons() {
      monthButtonsDiv.innerHTML = '';
      const thisYear = new Date().getFullYear();
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ù„Ø¢Ø®Ø± 12 Ø´Ù‡Ø±Ø§Ù‹ (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ)
      for (let i = 0; i < 12; i++) {
        const date = new Date();
        date.setMonth(date.getMonth() - i);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const monthName = monthNames[date.getMonth()];
        const key = `user_points_${year}_${month}`;
        
        const btn = document.createElement('button');
        btn.className = 'month-btn';
        btn.innerText = `${monthName} ${year}`;
        btn.dataset.key = key;
        btn.onclick = () => loadLeaderboard(key);
        
        // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
        if (key === currentKey) {
          btn.classList.add('active');
        }
        
        monthButtonsDiv.appendChild(btn);
      }
    }

    function showUserData(name, pointsKey) {
      const modal = document.getElementById('userModal');
      const body = document.getElementById('modalBody');
      const allPoints = JSON.parse(localStorage.getItem(pointsKey)) || {};
      const info = allUsersData[name];
      if (!info) {
        body.innerHTML = `<p class="no-data">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§ØªØµØ§Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….</p>`;
      } else {
        body.innerHTML = `
          <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${escapeHtml(info.name || '')}</p>
          <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${escapeHtml(info.phone || '')}</p>
          <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${escapeHtml(info.address || '')}</p>
          <p><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> ${escapeHtml(info.email || '')}</p>
          <p><strong>Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±:</strong> ${escapeHtml(String(allPoints[info.name] || 0))}</p>
        `;
      }
      modal.style.display = 'flex';
    }

    function hideModal() { document.getElementById('userModal').style.display = 'none'; }
    function closeModal(event) { if (event.target.id === 'userModal') hideModal(); }
    function escapeHtml(text) { return String(text).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }

    async function deleteUser(name, pointsKey) {
      if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù "${name}"ØŸ`)) {
        try {
          await db.collection(pointsKey).doc(name).delete();
        } catch (e) {
          console.warn("âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firestore:", e);
        }
        const allPoints = JSON.parse(localStorage.getItem(pointsKey)) || {};
        delete allPoints[name];
        localStorage.setItem(pointsKey, JSON.stringify(allPoints));
        loadLeaderboard(pointsKey);
      }
    }

    function sortByName() {
      const rows = Array.from(leaderboard.querySelectorAll('tr'));
      const sortedRows = rows.sort((a, b) => {
        const nameA = a.querySelector('.username')?.textContent || '';
        const nameB = b.querySelector('.username')?.textContent || '';
        return nameA.localeCompare(nameB, 'ar');
      });
      leaderboard.innerHTML = '';
      sortedRows.forEach((row, i) => {
        if (i === 0) row.classList.add('winner');
        leaderboard.appendChild(row);
      });
    }
  </script>
</body>
</html>