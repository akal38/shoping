<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة المتصدرين 🏆</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(to bottom, #fdfcfb, #e2d1c3);
      padding: 20px;
      text-align: center;
      margin: 0;
    }
    h1 {
      color: #6a1b9a;
      margin-bottom: 25px;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .month-btn {
      margin: 2px;
      padding: 8px 16px;
      background-color: #6a1b9a;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    .month-btn:hover {
      background-color: #4a148c;
    }
    .month-btn.active {
      background-color: #4a148c;
      box-shadow: 0 0 0 2px white, 0 0 0 4px #6a1b9a;
    }
    .leaderboard-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 15px;
      border-bottom: 1px solid #eee;
      text-align: center;
    }
    th {
      background-color: #6a1b9a;
      color: white;
      position: sticky;
      top: 0;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .winner {
      background-color: #ffeb3b;
      font-weight: bold;
    }
    .winner td:first-child {
      font-size: 1.2em;
    }
    .back-btn {
      margin-top: 30px;
      background-color: #6a1b9a;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .back-btn:hover {
      background-color: #4a148c;
      transform: translateY(-2px);
    }
    .username {
      color: #1a73e8;
      cursor: pointer;
      text-decoration: underline;
      font-weight: bold;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      align-items: center;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
    }
    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 10px;
      max-width: 500px;
      width: 100%;
      text-align: right;
      box-shadow: 0 4px 30px rgba(0,0,0,0.2);
      position: relative;
    }
    .modal-title {
      margin-top: 0;
      color: #6a1b9a;
      text-align: center;
      font-size: 1.4em;
    }
    .modal-close {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #6a1b9a;
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    .user-info {
      margin-top: 20px;
    }
    .info-row {
      display: flex;
      margin-bottom: 15px;
      align-items: center;
    }
    .info-label {
      font-weight: bold;
      color: #555;
      min-width: 100px;
    }
    .info-value {
      flex: 1;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 6px;
      word-break: break-word;
    }
    .no-data {
      padding: 20px;
      color: #777;
      text-align: center;
    }
    .action-btns {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: center;
    }
    .action-btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s ease;
    }
    .email-btn {
      background: #1e88e5;
      color: white;
    }
    .email-btn:hover {
      background: #1565c0;
    }
    .call-btn {
      background: #43a047;
      color: white;
    }
    .call-btn:hover {
      background: #2e7d32;
    }
    .delete-btn {
      background: #e53935;
      color: white;
    }
    .delete-btn:hover {
      background: #c62828;
    }
    .sort-btn {
      background: #6a1b9a;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
      font-size: 12px;
    }
    @media (max-width: 600px) {
      th, td {
        padding: 10px 5px;
        font-size: 14px;
      }
      .month-btn {
        padding: 6px 12px;
        font-size: 12px;
      }
      .modal-content {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <h1>🏆 لوحة المتصدرين</h1>

  <div class="controls" id="monthButtons"></div>

  <div class="leaderboard-container">
    <table>
      <thead>
        <tr>
          <th>الترتيب</th>
          <th>
            الاسم
            <button onclick="sortByName()" class="sort-btn">🔤 ترتيب أبجدي</button>
          </th>
          <th>عدد النقاط</th>
          <th>خيارات</th>
        </tr>
      </thead>
      <tbody id="leaderboard">
        <tr>
          <td colspan="4" class="no-data">جاري تحميل البيانات...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <button class="back-btn" onclick="window.location.href='admin.html'">العودة لصفحة الإدارة ⚙️</button>

  <div id="userModal" class="modal" onclick="closeModal(event)">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <button class="modal-close" onclick="hideModal()">×</button>
      <h3 id="modalTitle" class="modal-title">بيانات المستخدم</h3>
      <div id="modalBody" class="user-info">
        <div class="no-data">جاري تحميل البيانات...</div>
      </div>
      <div class="action-btns" id="modalActions"></div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // 1- تهيئة Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCHbyGbGx7P5mu6h0PecHGInvfX63Wvzqw",
      authDomain: "my-shop-96a73.firebaseapp.com",
      projectId: "my-shop-96a73",
      storageBucket: "my-shop-96a73.appspot.com",
      messagingSenderId: "242872774955",
      appId: "1:242872774955:web:1b281b329bc189ea3e556e",
      measurementId: "G-NP5FHDTHEL"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // متغيرات التطبيق
    const monthNames = ['جانفي', 'فيفري', 'مارس', 'أفريل', 'ماي', 'جوان', 'جويلية', 'أوت', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
    let currentMonthKey = '';
    let allUsersData = {};

    // 2- تحميل بيانات المستخدمين من Firestore
    async function loadUsersData() {
      try {
        const snapshot = await db.collection("users").get();
        allUsersData = {};
        snapshot.forEach(doc => {
          allUsersData[doc.id] = doc.data();
        });
        createMonthButtons();
      } catch (error) {
        console.error("Error loading users data:", error);
        // استخدام البيانات المحلية كنسخة احتياطية
        allUsersData = JSON.parse(localStorage.getItem('user_data')) || {};
        createMonthButtons();
      }
    }

    // 3- إنشاء أزرار الشهور
    function createMonthButtons() {
      const monthButtonsDiv = document.getElementById('monthButtons');
      monthButtonsDiv.innerHTML = '';
      
      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth();
      
      // عرض شهور السنة الحالية والسنة الماضية
      for (let year = currentYear; year >= currentYear - 1; year--) {
        for (let month = 11; month >= 0; month--) {
          // لا نعرض شهور المستقبل
          if (year === currentYear && month > currentMonth) continue;
          
          const monthNumber = String(month + 1).padStart(2, '0');
          const key = `user_points_${year}_${monthNumber}`;
          const btn = document.createElement('button');
          btn.className = 'month-btn';
          btn.innerText = `${monthNames[month]} ${year}`;
          btn.dataset.key = key;
          
          // تحديد الشهر الحالي كافتراضي
          if (year === currentYear && month === currentMonth) {
            btn.classList.add('active');
            currentMonthKey = key;
            loadLeaderboard(key);
          }
          
          btn.onclick = () => {
            document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentMonthKey = key;
            loadLeaderboard(key);
          };
          
          monthButtonsDiv.appendChild(btn);
        }
      }
    }

    // 4- تحميل لوحة المتصدرين
    async function loadLeaderboard(pointsKey) {
      const leaderboard = document.getElementById('leaderboard');
      leaderboard.innerHTML = '<tr><td colspan="4" class="no-data">جاري تحميل البيانات...</td></tr>';
      
      try {
        // محاولة جلب البيانات من Firestore أولاً
        const snapshot = await db.collection("monthly_points").doc(pointsKey).get();
        let pointsData = {};
        
        if (snapshot.exists) {
          pointsData = snapshot.data();
        } else {
          // استخدام البيانات المحلية كنسخة احتياطية
          pointsData = JSON.parse(localStorage.getItem(pointsKey)) || {};
        }
        
        const users = Object.keys(pointsData).map(name => {
          return { name: name, points: pointsData[name] };
        });

        users.sort((a, b) => b.points - a.points);
        displayLeaderboard(users);
      } catch (error) {
        console.error("Error loading leaderboard:", error);
        leaderboard.innerHTML = `
          <tr>
            <td colspan="4" class="no-data">⚠️ حدث خطأ في تحميل البيانات. الرجاء المحاولة لاحقاً.</td>
          </tr>
        `;
      }
    }

    // 5- عرض لوحة المتصدرين
    function displayLeaderboard(users) {
      const leaderboard = document.getElementById('leaderboard');
      
      if (users.length === 0) {
        leaderboard.innerHTML = `
          <tr>
            <td colspan="4" class="no-data">📭 لا توجد بيانات لهذا الشهر</td>
          </tr>
        `;
        return;
      }

      leaderboard.innerHTML = '';
      users.forEach((user, index) => {
        const row = document.createElement('tr');
        if (index === 0) row.classList.add('winner');

        const safeName = escapeHtml(user.name);
        row.innerHTML = `
          <td>${index + 1}</td>
          <td><span class="username" data-name="${safeName}">${safeName}</span></td>
          <td>${user.points}</td>
          <td>
            <button onclick="showUserData('${safeName}')" class="action-btn" style="background:#6a1b9a; color:white; padding:5px 10px; font-size:12px;">
              عرض التفاصيل
            </button>
          </td>
        `;
        leaderboard.appendChild(row);
      });

      // ربط أحداث النقر على أسماء المستخدمين
      document.querySelectorAll('.username').forEach(el => {
        el.addEventListener('click', (e) => {
          const name = e.currentTarget.getAttribute('data-name');
          showUserData(name);
        });
      });
    }

    // 6- عرض بيانات المستخدم في النافذة المنبثقة
    async function showUserData(name) {
      const modal = document.getElementById('userModal');
      const modalBody = document.getElementById('modalBody');
      const modalActions = document.getElementById('modalActions');
      
      modalBody.innerHTML = '<div class="no-data">جاري تحميل البيانات...</div>';
      modalActions.innerHTML = '';
      modal.style.display = 'flex';
      
      const userInfo = allUsersData[name] || {};
      const points = await getUserPoints(name, currentMonthKey);
      
      modalBody.innerHTML = `
        <div class="info-row">
          <span class="info-label">الاسم:</span>
          <span class="info-value">${escapeHtml(userInfo.name || name)}</span>
        </div>
        <div class="info-row">
          <span class="info-label">الهاتف:</span>
          <span class="info-value">${escapeHtml(userInfo.phone || 'غير متوفر')}</span>
        </div>
        <div class="info-row">
          <span class="info-label">العنوان:</span>
          <span class="info-value">${escapeHtml(userInfo.address || 'غير متوفر')}</span>
        </div>
        <div class="info-row">
          <span class="info-label">البريد الإلكتروني:</span>
          <span class="info-value">${escapeHtml(userInfo.email || 'غير متوفر')}</span>
        </div>
        <div class="info-row">
          <span class="info-label">النقاط:</span>
          <span class="info-value">${points}</span>
        </div>
      `;
      
      // إضافة أزرار الإجراءات إذا توفرت معلومات الاتصال
      if (userInfo.phone || userInfo.email) {
        modalActions.innerHTML = '';
        if (userInfo.email) {
          modalActions.innerHTML += `
            <button class="action-btn email-btn" onclick="sendEmail('${userInfo.email}')">
              ✉️ إرسال بريد
            </button>
          `;
        }
        if (userInfo.phone) {
          modalActions.innerHTML += `
            <button class="action-btn call-btn" onclick="makeCall('${userInfo.phone}')">
              📞 إجراء اتصال
            </button>
          `;
        }
        modalActions.innerHTML += `
          <button class="action-btn delete-btn" onclick="deleteUser('${name}')">
            🗑️ حذف المستخدم
          </button>
        `;
      }
    }

    // 7- الحصول على نقاط المستخدم لشهر معين
    async function getUserPoints(name, pointsKey) {
      try {
        const snapshot = await db.collection("monthly_points").doc(pointsKey).get();
        if (snapshot.exists) {
          return snapshot.data()[name] || 0;
        } else {
          const localData = JSON.parse(localStorage.getItem(pointsKey)) || {};
          return localData[name] || 0;
        }
      } catch (error) {
        console.error("Error getting user points:", error);
        return 0;
      }
    }

    // 8- حذف مستخدم
    async function deleteUser(name) {
      if (!confirm(`هل أنت متأكد أنك تريد حذف "${name}"؟ سيتم حذف جميع بياناته.`)) return;
      
      try {
        // حذف من Firestore
        await db.collection("users").doc(name).delete();
        
        // حذف من البيانات المحلية
        delete allUsersData[name];
        
        // تحديث لوحة المتصدرين
        loadLeaderboard(currentMonthKey);
        hideModal();
      } catch (error) {
        console.error("Error deleting user:", error);
        alert("حدث خطأ أثناء حذف المستخدم");
      }
    }

    // 9- وظائف مساعدة
    function hideModal() {
      document.getElementById('userModal').style.display = 'none';
    }

    function closeModal(event) {
      if (event.target.id === 'userModal') {
        hideModal();
      }
    }

    function escapeHtml(text) {
      if (!text) return "";
      return text.toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function sendEmail(email) {
      if (!email || email === "غير متوفر") {
        return alert("لا يوجد بريد إلكتروني مسجل");
      }
      window.location.href = `mailto:${email}?subject=تهانينا! أنت من المتصدرين`;
    }

    function makeCall(phone) {
      if (!phone || phone === "غير متوفر") {
        return alert("لا يوجد رقم هاتف مسجل");
      }
      window.location.href = `tel:${phone}`;
    }

    function sortByName() {
      const leaderboard = document.getElementById('leaderboard');
      const rows = Array.from(leaderboard.querySelectorAll('tr'));
      
      const sortedRows = rows.sort((a, b) => {
        const nameA = a.querySelector('.username')?.textContent || '';
        const nameB = b.querySelector('.username')?.textContent || '';
        return nameA.localeCompare(nameB, 'ar');
      });
      
      leaderboard.innerHTML = '';
      sortedRows.forEach((row, index) => {
        if (index === 0) row.classList.add('winner');
        leaderboard.appendChild(row);
      });
    }

    // بدء التطبيق
    document.addEventListener('DOMContentLoaded', loadUsersData);
  </script>
</body>
</html>