<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† ğŸ†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(to bottom, #fdfcfb, #e2d1c3);
      padding: 20px;
      text-align: center;
      margin: 0;
    }
    h1 {
      color: #6a1b9a;
      margin-bottom: 25px;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .month-btn {
      margin: 2px;
      padding: 8px 16px;
      background-color: #6a1b9a;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    .month-btn:hover {
      background-color: #4a148c;
    }
    .month-btn.active {
      background-color: #4a148c;
      box-shadow: 0 0 0 2px white, 0 0 0 4px #6a1b9a;
    }
    .leaderboard-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 15px;
      border-bottom: 1px solid #eee;
      text-align: center;
    }
    th {
      background-color: #6a1b9a;
      color: white;
      position: sticky;
      top: 0;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .winner {
      background-color: #ffeb3b;
      font-weight: bold;
    }
    .winner td:first-child {
      font-size: 1.2em;
    }
    .back-btn {
      margin-top: 30px;
      background-color: #6a1b9a;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .back-btn:hover {
      background-color: #4a148c;
      transform: translateY(-2px);
    }
    .username {
      color: #1a73e8;
      cursor: pointer;
      text-decoration: underline;
      font-weight: bold;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      align-items: center;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
    }
    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 10px;
      max-width: 500px;
      width: 100%;
      text-align: right;
      box-shadow: 0 4px 30px rgba(0,0,0,0.2);
      position: relative;
    }
    .modal-title {
      margin-top: 0;
      color: #6a1b9a;
      text-align: center;
      font-size: 1.4em;
    }
    .modal-close {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #6a1b9a;
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    .user-info {
      margin-top: 20px;
    }
    .info-row {
      display: flex;
      margin-bottom: 15px;
      align-items: center;
    }
    .info-label {
      font-weight: bold;
      color: #555;
      min-width: 100px;
    }
    .info-value {
      flex: 1;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 6px;
      word-break: break-word;
    }
    .no-data {
      padding: 20px;
      color: #777;
      text-align: center;
    }
    .action-btns {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: center;
    }
    .action-btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s ease;
    }
    .email-btn {
      background: #1e88e5;
      color: white;
    }
    .email-btn:hover {
      background: #1565c0;
    }
    .call-btn {
      background: #43a047;
      color: white;
    }
    .call-btn:hover {
      background: #2e7d32;
    }
    .delete-btn {
      background: #e53935;
      color: white;
    }
    .delete-btn:hover {
      background: #c62828;
    }
    .sort-btn {
      background: #6a1b9a;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
      font-size: 12px;
    }
    @media (max-width: 600px) {
      th, td {
        padding: 10px 5px;
        font-size: 14px;
      }
      .month-btn {
        padding: 6px 12px;
        font-size: 12px;
      }
      .modal-content {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <h1>ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h1>

  <div class="controls" id="monthButtons"></div>

  <div class="leaderboard-container">
    <table>
      <thead>
        <tr>
          <th>Ø§Ù„ØªØ±ØªÙŠØ¨</th>
          <th>
            Ø§Ù„Ø§Ø³Ù…
            <button onclick="sortByName()" class="sort-btn">ğŸ”¤ ØªØ±ØªÙŠØ¨ Ø£Ø¨Ø¬Ø¯ÙŠ</button>
          </th>
          <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·</th>
          <th>Ø®ÙŠØ§Ø±Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="leaderboard">
        <tr>
          <td colspan="4" class="no-data">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <button class="back-btn" onclick="window.location.href='admin.html'">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© âš™ï¸</button>

  <div id="userModal" class="modal" onclick="closeModal(event)">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <button class="modal-close" onclick="hideModal()">Ã—</button>
      <h3 id="modalTitle" class="modal-title">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
      <div id="modalBody" class="user-info">
        <div class="no-data">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
      </div>
      <div class="action-btns" id="modalActions"></div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // 1- ØªÙ‡ÙŠØ¦Ø© Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCHbyGbGx7P5mu6h0PecHGInvfX63Wvzqw",
      authDomain: "my-shop-96a73.firebaseapp.com",
      projectId: "my-shop-96a73",
      storageBucket: "my-shop-96a73.appspot.com",
      messagingSenderId: "242872774955",
      appId: "1:242872774955:web:1b281b329bc189ea3e556e",
      measurementId: "G-NP5FHDTHEL"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    const monthNames = ['Ø¬Ø§Ù†ÙÙŠ', 'ÙÙŠÙØ±ÙŠ', 'Ù…Ø§Ø±Ø³', 'Ø£ÙØ±ÙŠÙ„', 'Ù…Ø§ÙŠ', 'Ø¬ÙˆØ§Ù†', 'Ø¬ÙˆÙŠÙ„ÙŠØ©', 'Ø£ÙˆØª', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
    let currentMonthKey = '';
    let allUsersData = {};

    // 2- ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Firestore
    async function loadUsersData() {
      try {
        const snapshot = await db.collection("users").get();
        allUsersData = {};
        snapshot.forEach(doc => {
          allUsersData[doc.id] = doc.data();
        });
        createMonthButtons();
      } catch (error) {
        console.error("Error loading users data:", error);
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        allUsersData = JSON.parse(localStorage.getItem('user_data')) || {};
        createMonthButtons();
      }
    }

    // 3- Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´Ù‡ÙˆØ±
    function createMonthButtons() {
      const monthButtonsDiv = document.getElementById('monthButtons');
      monthButtonsDiv.innerHTML = '';
      
      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth();
      
      // Ø¹Ø±Ø¶ Ø´Ù‡ÙˆØ± Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø§Ø¶ÙŠØ©
      for (let year = currentYear; year >= currentYear - 1; year--) {
        for (let month = 11; month >= 0; month--) {
          // Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø´Ù‡ÙˆØ± Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
          if (year === currentYear && month > currentMonth) continue;
          
          const monthNumber = String(month + 1).padStart(2, '0');
          const key = `user_points_${year}_${monthNumber}`;
          const btn = document.createElement('button');
          btn.className = 'month-btn';
          btn.innerText = `${monthNames[month]} ${year}`;
          btn.dataset.key = key;
          
          // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ
          if (year === currentYear && month === currentMonth) {
            btn.classList.add('active');
            currentMonthKey = key;
            loadLeaderboard(key);
          }
          
          btn.onclick = () => {
            document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentMonthKey = key;
            loadLeaderboard(key);
          };
          
          monthButtonsDiv.appendChild(btn);
        }
      }
    }

    // 4- ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†
    async function loadLeaderboard(pointsKey) {
      const leaderboard = document.getElementById('leaderboard');
      leaderboard.innerHTML = '<tr><td colspan="4" class="no-data">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>';
      
      try {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firestore Ø£ÙˆÙ„Ø§Ù‹
        const snapshot = await db.collection("monthly_points").doc(pointsKey).get();
        let pointsData = {};
        
        if (snapshot.exists) {
          pointsData = snapshot.data();
        } else {
          // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
          pointsData = JSON.parse(localStorage.getItem(pointsKey)) || {};
        }
        
        const users = Object.keys(pointsData).map(name => {
          return { name: name, points: pointsData[name] };
        });

        users.sort((a, b) => b.points - a.points);
        displayLeaderboard(users);
      } catch (error) {
        console.error("Error loading leaderboard:", error);
        leaderboard.innerHTML = `
          <tr>
            <td colspan="4" class="no-data">âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.</td>
          </tr>
        `;
      }
    }

    // 5- Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†
    function displayLeaderboard(users) {
      const leaderboard = document.getElementById('leaderboard');
      
      if (users.length === 0) {
        leaderboard.innerHTML = `
          <tr>
            <td colspan="4" class="no-data">ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</td>
          </tr>
        `;
        return;
      }

      leaderboard.innerHTML = '';
      users.forEach((user, index) => {
        const row = document.createElement('tr');
        if (index === 0) row.classList.add('winner');

        const safeName = escapeHtml(user.name);
        row.innerHTML = `
          <td>${index + 1}</td>
          <td><span class="username" data-name="${safeName}">${safeName}</span></td>
          <td>${user.points}</td>
          <td>
            <button onclick="showUserData('${safeName}')" class="action-btn" style="background:#6a1b9a; color:white; padding:5px 10px; font-size:12px;">
              Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
            </button>
          </td>
        `;
        leaderboard.appendChild(row);
      });

      // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
      document.querySelectorAll('.username').forEach(el => {
        el.addEventListener('click', (e) => {
          const name = e.currentTarget.getAttribute('data-name');
          showUserData(name);
        });
      });
    }

    // 6- Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
    async function showUserData(name) {
      const modal = document.getElementById('userModal');
      const modalBody = document.getElementById('modalBody');
      const modalActions = document.getElementById('modalActions');
      
      modalBody.innerHTML = '<div class="no-data">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>';
      modalActions.innerHTML = '';
      modal.style.display = 'flex';
      
      const userInfo = allUsersData[name] || {};
      const points = await getUserPoints(name, currentMonthKey);
      
      modalBody.innerHTML = `
        <div class="info-row">
          <span class="info-label">Ø§Ù„Ø§Ø³Ù…:</span>
          <span class="info-value">${escapeHtml(userInfo.name || name)}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Ø§Ù„Ù‡Ø§ØªÙ:</span>
          <span class="info-value">${escapeHtml(userInfo.phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±')}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</span>
          <span class="info-value">${escapeHtml(userInfo.address || 'ØºÙŠØ± Ù…ØªÙˆÙØ±')}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</span>
          <span class="info-value">${escapeHtml(userInfo.email || 'ØºÙŠØ± Ù…ØªÙˆÙØ±')}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Ø§Ù„Ù†Ù‚Ø§Ø·:</span>
          <span class="info-value">${points}</span>
        </div>
      `;
      
      // Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¥Ø°Ø§ ØªÙˆÙØ±Øª Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
      if (userInfo.phone || userInfo.email) {
        modalActions.innerHTML = '';
        if (userInfo.email) {
          modalActions.innerHTML += `
            <button class="action-btn email-btn" onclick="sendEmail('${userInfo.email}')">
              âœ‰ï¸ Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯
            </button>
          `;
        }
        if (userInfo.phone) {
          modalActions.innerHTML += `
            <button class="action-btn call-btn" onclick="makeCall('${userInfo.phone}')">
              ğŸ“ Ø¥Ø¬Ø±Ø§Ø¡ Ø§ØªØµØ§Ù„
            </button>
          `;
        }
        modalActions.innerHTML += `
          <button class="action-btn delete-btn" onclick="deleteUser('${name}')">
            ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
          </button>
        `;
      }
    }

    // 7- Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø´Ù‡Ø± Ù…Ø¹ÙŠÙ†
    async function getUserPoints(name, pointsKey) {
      try {
        const snapshot = await db.collection("monthly_points").doc(pointsKey).get();
        if (snapshot.exists) {
          return snapshot.data()[name] || 0;
        } else {
          const localData = JSON.parse(localStorage.getItem(pointsKey)) || {};
          return localData[name] || 0;
        }
      } catch (error) {
        console.error("Error getting user points:", error);
        return 0;
      }
    }

    // 8- Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…
    async function deleteUser(name) {
      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù "${name}"ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡.`)) return;
      
      try {
        // Ø­Ø°Ù Ù…Ù† Firestore
        await db.collection("users").doc(name).delete();
        
        // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        delete allUsersData[name];
        
        // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†
        loadLeaderboard(currentMonthKey);
        hideModal();
      } catch (error) {
        console.error("Error deleting user:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
      }
    }

    // 9- ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø©
    function hideModal() {
      document.getElementById('userModal').style.display = 'none';
    }

    function closeModal(event) {
      if (event.target.id === 'userModal') {
        hideModal();
      }
    }

    function escapeHtml(text) {
      if (!text) return "";
      return text.toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function sendEmail(email) {
      if (!email || email === "ØºÙŠØ± Ù…ØªÙˆÙØ±") {
        return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„");
      }
      window.location.href = `mailto:${email}?subject=ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ø£Ù†Øª Ù…Ù† Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†`;
    }

    function makeCall(phone) {
      if (!phone || phone === "ØºÙŠØ± Ù…ØªÙˆÙØ±") {
        return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù…Ø³Ø¬Ù„");
      }
      window.location.href = `tel:${phone}`;
    }

    function sortByName() {
      const leaderboard = document.getElementById('leaderboard');
      const rows = Array.from(leaderboard.querySelectorAll('tr'));
      
      const sortedRows = rows.sort((a, b) => {
        const nameA = a.querySelector('.username')?.textContent || '';
        const nameB = b.querySelector('.username')?.textContent || '';
        return nameA.localeCompare(nameB, 'ar');
      });
      
      leaderboard.innerHTML = '';
      sortedRows.forEach((row, index) => {
        if (index === 0) row.classList.add('winner');
        leaderboard.appendChild(row);
      });
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    document.addEventListener('DOMContentLoaded', loadUsersData);
  </script>
</body>
</html>